---
title: "covariates"
author: "Amy Van Scoyoc"
date: "4/15/2022"
output: github_document
---

### Import Libraries
```{r}
library(here) #reproducible working directory
library(tidyverse) #data tidying
library(sf) #modifying spatial attributes 
library(raster) #reclassify, stack environmental covariates
library(sdmvspecies) #rescale environmental covariates 
library(tmap) #plots
```

### Reclassify Land Cover

```{r}
#import hopland layer 
hopland <- st_read(here("data_covariates", "HREC_boundary", "HREC_boundary.shp"))
#import elevation layer for mt lions
elev <- raster(here("data_covariates", "HREC_elevation_extended.tif"))
#import slope layer for hunters
slope <- raster(here("data_covariates", "HREC_slope_extended.tif"))
#import landcover layer
lc <- raster(here("data_covariates", "HREC_landcover_extended.tif"))
#freq(lc)
```

```{r}
#create development vector
dev_vec <- c(-1, 21, NA, #set others to NA 
            21, 25, 1,  #combine developed landcover 22, 23, 24
            25, Inf, NA) %>% #set others to NA
            matrix(., ncol = 3, byrow = T)

#create forest road vector
road_vec <- c(-1, 20, NA, #set others to NA 
            20, 21, 1,  #combine light dev landcover 21
            21, Inf, NA) %>% #set others to NA
            matrix(., ncol = 3, byrow = T)

#create cropland layer
crop_vec <- c(-1, 80, NA, #set others to NA 
            80, 82, 1,  #combine grass pasture layer 81, 82
            82, Inf, NA) %>% #set others to NA
            matrix(., ncol = 3, byrow = T)

#create livestock/pasture land layer
grass_vec <- c(-1, 70, NA, #set others to NA 
            70, 71, 1,  #combine grass pasture layer 71
            71, Inf, NA) %>% #set others to NA
            matrix(., ncol = 3, byrow = T)

#create shrub land layer
shrub_vec <- c(-1, 51, NA, #set others to NA 
            51, 52, 1,  #combine grass pasture layer 71
            52, Inf, NA) %>% #set others to NA
            matrix(., ncol = 3, byrow = T)

#create habitat cover layer
forest_vec <- c(-1, 40, NA, #set others to NA 
            40, 43, 1,  #combine forest 41, 42, 43
            43, 51, NA, #set others to NA 
            51, 52, NA, #set to NA for now -- combine shrub 52???
            52, Inf, NA) %>% #set others to NA
            matrix(., ncol = 3, byrow = T)

water_vec <- c(-1, 10, NA, #set others to NA 
            10, 11, 1,  #combine water 11
            11, 89, NA, #set others to NA 
            89, 95, 1, #combine water 90 and 95
            95, Inf, NA) %>% #set others to NA
            matrix(., ncol = 3, byrow = T)

#lion habitat layer
lion_vec <- c(-1, 40, NA, #set others to NA 
            40, 43, 0,  #combine forest 41, 42, 43 (med visibility)
            43, 51, NA, #set others to NA 
            51, 52, 1, #combine shrub 52 (least visibility)
            52, 70, NA, #set others to NA  
            70, 71, 0, #combine grassland 71 (most visible) 
            71, Inf, NA) %>% #set others to NA  
            matrix(., ncol = 3, byrow = T)

#hunter habitat layer
viewshed_vec <- c(-1, 40, NA, #set others to NA 
            40, 43, 1,  #combine forest 41, 42, 43 (med visibility)
            43, 51, NA, #set others to NA 
            51, 52, 0, #combine shrub 52 (least visibility)
            52, 70, NA, #set others to NA  
            70, 71, 2, #combine grassland 71 (most visible) 
            71, Inf, NA) %>% #set others to NA  
            matrix(., ncol = 3, byrow = T)
```

```{r}
#reclassify land cover values 
dev <- reclassify(lc, dev_vec)
road <- reclassify(lc, road_vec)
crop <- reclassify(lc, crop_vec)

grass <- reclassify(lc, grass_vec)
forest <- reclassify(lc, forest_vec)
shrub <- reclassify(lc, shrub_vec)
water <- reclassify(lc, water_vec)

lion <- reclassify(lc, lion_vec)
viewshed <- reclassify(lc, viewshed_vec)
```

```{r}
#create distance rasters
dev_dist <- gridDistance(dev, origin = 1)
road_dist <- gridDistance(road, origin = 1)
crop_dist <- gridDistance(crop, origin = 1)

grass_dist <- gridDistance(grass, origin = 1)
forest_dist <- gridDistance(forest, origin = 1)
shrub_dist <- gridDistance(shrub, origin = 1)
water_dist <- gridDistance(water, origin = 1)
```

### Lion Risk layer

Model = Shrub Habitat, Elevation
```{r}
#rescale & stack
elev_sc <- rescale(elev) #scale elevation layer 
lion <- stack(lion, elev_sc) #stack habitat and elevation
lion <- stackApply(lion, indices = rep(1, nlayers(lion)), fun = sum) #sum 
p0 <- tm_shape(lion) + tm_raster(style = "cont", palette = "YlOrRd") + tm_shape(hopland) + tm_borders(col = "black") + tm_layout(legend.show = F,title='Lion Risk',legend.outside = T,title.position=c("center",'top'))
```

### Hunter risk layer

Model = Visibility, Road Dist, Slope
```{r}
#create parcel mask for where hunters won't hunt
parcels <- raster::buffer(dev, width = 150)
#rescale
road_sc <- rescale(-road_dist) #scale inverse of road layer 
slope_sc <- rescale(slope) #scale slope layer 
viewshed_sc <- rescale(viewshed) #scale hunter layer
#stack
hunter <- stack(viewshed_sc, road_sc, slope_sc) #stack habitat and elevation
hunter <- stackApply(hunter, indices = rep(1, nlayers(hunter)), fun = sum) #sum scaled values
hunter <- mask(hunter, parcels, inverse=TRUE) #remove dev from hunter risk
hunter[is.na(hunter)] <- 0 #set masked values to 0 instead of NA
#plot hunter risk 
p1 <- tm_shape(hunter) + tm_raster(style = "cont", palette = "YlOrRd") + tm_shape(hopland) + tm_borders(col = "black") + tm_layout(legend.show = F,title='Hunter Risk',legend.outside = T,title.position=c("center",'top'))
```

### Other layers
```{r}
tmlayer <- function(layer,title){
  tm_shape(layer) + 
    tm_raster(style = "cont", palette = "seq") +
  tm_layout(aes.palette = list(seq = "-YlOrRd")) +
  tm_shape(hopland) + 
    tm_borders(col = "white") + 
    tm_layout(legend.show = F, title=title, title.color = "white",
              legend.outside = T, title.position=c("center","bottom")) 
}

tmap_arrange(
  tmlayer(dev_dist, "Development"), tmlayer(crop_dist, "Crop"),
  tmlayer(grass_dist, "Pasture"), tmlayer(water_dist, "Water"), 
  tmlayer(forest_dist, "Forest"), tmlayer(shrub_dist, "Shrub"), p0, p1, ncol = 4)

```

### Models
```{r}
envt <- stack(elev, slope, dev_dist, road_dist, crop_dist, 
              grass_dist, forest_dist, shrub_dist, water_dist, 
              lion, hunter)
names(envt) <- c("elev", "slope", "dev_dist","road_dist","crop_dist",
                 "grass_dist","forest_dist","shrub_dist","water_dist",
                 "lion","hunter")
save(envt, file = "data_objects/envt.Rdata")
```

