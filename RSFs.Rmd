---
title: "RSFs"
author: "Amy Van Scoyoc"
date: "4/14/2022"
output: github_document
---

```{r}
library(here) #reproducible working directory
library(tidyverse) #data wrangling
library(lubridate) #setting timezone
library(maptools) #setting day/night times
library(sp) #for spatial points
library(sf) #for spatial transformations with pipes
library(adehabitatHR) #for calculating homerange KUDs
library(raster) #for importing and extracting covariates
library(lme4) #for glmer models
library(sjPlot) #table of RSF covariates
library(jtools) #plot all model estimates together
```


### Load coyote data with HMM states, add day/night

```{r}
#import dataset
coyote <- read_csv(here("data", "hmm_dat.csv"))
#transform to geographic crs for sunriset
coordinates(coyote) <- c("x", "y")
proj4string(coyote) <- CRS("+init=epsg:26910")
coyote <- spTransform(coyote, CRS("+init=epsg:4326")) %>% as.data.frame() 
#add sunriset times
coyote <- coyote %>% 
  mutate(t = force_tz(t,tz = "America/Los_Angeles"), #declare timezone
         sunrise = sunriset(SpatialPoints(cbind(x,y),proj4string=CRS("+init=epsg:4326")), 
                                      t, direction="sunrise", POSIXct.out=TRUE)[,2],
         sunset = sunriset(SpatialPoints(cbind(x,y),proj4string=CRS("+init=epsg:4326")), 
                                      t, direction="sunset", POSIXct.out=TRUE)[,2],
         daynight = ifelse(t > sunrise & t < sunset, 1, 0), #assign tags, 1=day, 0=night 
         sex = ifelse(grepl("^F",ID),"female","male")) %>% 
  dplyr::select(ID, x, y, t, states, daynight, sex)

save(coyote, file = "data_objects/coyote.Rdata")
```


### Calculate Home Ranges (Kernel Utilization Distribution)
```{r}
#create object for calculating HRs
coyote_sp <- coyote %>% 
   dplyr::select(ID,x,y) %>% #select data 
   st_as_sf(., coords = c("x","y"), crs = "+init=epsg:4326") %>%  #make spatial object
   st_transform("+init=epsg:26910") %>% #transform back to UTMs
   as("Spatial") #transform back to sp object for KUDs

#create Kernel Utilization Distributions 
kud_all <- adehabitatHR::kernelUD(coyote_sp, h = 'href')
coyote_hr <- adehabitatHR::getverticeshr(kud_all, percent = 95 , unout = "km2")
#save(coyote_hr, file = "data_objects/coyote_hr.Rdata")

#plot
plot(coyote_hr, col = coyote_hr$ID)

#HR area (km2)
kernel.area(kud_all, percent = 95) %>% 
  pivot_longer(1:8,names_to = "ID", values_to = "Area (km^2)")
```


### Sample available points in Home Ranges
```{r}
coyote_full <- coyote %>% mutate(Used = 1) %>% #add column to indicate used points
   st_as_sf(., coords = c("x","y"), crs = "+init=epsg:4326") %>%  #make spatial object
   st_transform("+init=epsg:26910")  #transform back to UTMs

coyote_ids <- unique(coyote_full$ID) # Extract a list of IDs
availables <- list() #empty list to store available pts by ID

# Randomly sample available points from within the home range of each individual
for(i in 1:length(coyote_ids)){
    st_sample(st_as_sf(coyote_hr)[i,], 5*nrow(filter(coyote_full, ID == coyote_ids[i]))) %>%  #5:1 ratio
    st_sf(geometry = .) %>%
    mutate(ID = coyote_ids[i], 
           t = NA,
           states = NA,
           daynight = NA,
           sex = NA,
           Used = 0) -> availables[[i]]  
}

# Then combine individual lists into one data.frame
# Then merge with used coyote GPS points data frame
coyote_full <- availables %>% 
  do.call(rbind,.) %>% 
  rbind(coyote_full, .)

# Check that we have a 5:1 ratio of used:available points
table(coyote_full$ID,coyote_full$Used)

#check
# plot(coyote_hr[8,])
# plot(st_geometry(filter(coyote_all,ID == "M5",Used == 0)),col="red",add=T)
# plot(st_geometry(filter(coyote_all,ID == "M5",Used == 1)),add=T)
```

### Import covariates
```{r}
load(here("data_objects","envt.Rdata"))
plot(envt)
```

### Scale and append covariates
```{r}
#append and scale covariates
coyote_full <- coyote_full %>% 
  mutate(elev.s = raster::extract(envt[[1]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         slope.s = raster::extract(envt[[2]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         dev_dist.s = raster::extract(envt[[3]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         road_dist.s = raster::extract(envt[[4]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         crop_dist.s = raster::extract(envt[[5]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         grass_dist.s = raster::extract(envt[[6]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         forest_dist.s = raster::extract(envt[[7]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         shrub_dist.s = raster::extract(envt[[8]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         water_dist.s = raster::extract(envt[[9]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         lion.s = raster::extract(envt[[10]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         hunter.s = raster::extract(envt[[11]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE))

# # Save your scale parameters - you'll need them for plotting later!
# lion_scalelist <- list(scale = attr(coyote_full$lion.scaled, "scaled:scale"),
#                      center = attr(coyote_full$lion.scaled, "scaled:center"))
```


### Check covariates for colinearity
```{r}
coyote_full$ID <- as_factor(coyote_full$ID) #make sure ID is treated as a factor

coyote_cor <- coyote_full
st_geometry(coyote_cor) <- NULL
cor(coyote_cor[,6:16])
#Water-Crop and Elevation-Crop are correlated >0.7, so dropped water and elevation. 
```


#Full models 

```{r}
library(performance)
phys_mod <- glmer(Used ~ slope.s + elev.s + road_dist.s + water_dist.s + (1|ID), 
                  data = coyote_full, family=binomial(link="logit"))
r2(phys_mod)
landuse_mod <- glmer(Used ~ crop_dist.s + grass_dist.s + forest_dist.s + shrub_dist.s + dev_dist.s + (1|ID), 
                  data = coyote_full, family=binomial(link="logit"))
r2(landuse_mod)
risk_mod <- glmer(Used ~ lion.s + hunter.s + (1|ID), 
                  data = coyote_full, family=binomial(link="logit"))
r2(risk_mod)
model_performance(phys_mod)
model_performance(landuse_mod)
model_performance(risk_mod)
anov <- anova(phys_mod, landuse_mod, risk_mod) #check which is highest adj. R^2
summary(phys_mod)
```


### Day top models

### Calculate Day Home Ranges (Kernel Utilization Distribution)
```{r}
#create object for calculating HRs
coyote_sp <- coyote %>%
   filter(daynight == 1) %>% #filter to day only
   dplyr::select(ID,x,y) %>% #select data 
   st_as_sf(., coords = c("x","y"), crs = "+init=epsg:4326") %>%  #make spatial object
   st_transform("+init=epsg:26910") %>% #transform back to UTMs
   as("Spatial") #transform back to sp object for KUDs

#create Kernel Utilization Distributions 
kud_all <- adehabitatHR::kernelUD(coyote_sp, h = 'href')
coyote_hr <- adehabitatHR::getverticeshr(kud_all, percent = 95 , unout = "km2")
#save(coyote_hr, file = "data_objects/coyote_hr.Rdata")

#plot
plot(coyote_hr, col = coyote_hr$ID)

#HR area (km2)
kernel.area(kud_all, percent = 95) %>% 
  pivot_longer(1:8,names_to = "ID", values_to = "Area (km^2)")

# Home range figure
# map <- leaflet(width = "65%", options = leafletOptions(zoomControl = FALSE), sdf_poly) %>% addTiles() %>%
#   addPolygons(weight = 1, fillOpacity = .4, color = ~pal(coyote_hr$id)) %>%
#   addLegend('bottomleft', pal = pal, values = ~coyote_hr$id, title = 'ID') %>% 
#   addMiniMap(
#     #tiles = providers$Esri.OceanBasemap,
#     position = 'topright', 
#     width = 100, height = 200,
#     zoomLevelOffset = -6) %>%
#   # add graticules with nice labels (recommended for static plot)
#   addScaleBar(position = c("bottomright"))
# library(mapview)
# mapshot(map, file = 'leaflet_map.png')
```


### Sample available points in Home Ranges
```{r}
coyote_day <- coyote %>% 
  filter(daynight == 1) %>% #filter to day only
  mutate(Used = 1) %>% #add column to indicate used points
   st_as_sf(., coords = c("x","y"), crs = "+init=epsg:4326") %>%  #make spatial object
   st_transform("+init=epsg:26910")  #transform back to UTMs

coyote_ids <- unique(coyote_day$ID) # Extract a list of IDs
availables <- list() #empty list to store available pts by ID

# Randomly sample available points from within the home range of each individual
for(i in 1:length(coyote_ids)){
    st_sample(st_as_sf(coyote_hr)[i,], 5*nrow(filter(coyote_day, ID == coyote_ids[i]))) %>%  #5:1 ratio
    st_sf(geometry = .) %>%
    mutate(ID = coyote_ids[i], 
           t = NA,
           states = NA,
           daynight = NA,
           sex = NA,
           Used = 0) -> availables[[i]]  
}

# Then combine individual lists into one data.frame
# Then merge with used coyote GPS points data frame
coyote_day <- availables %>% 
  do.call(rbind,.) %>% 
  rbind(coyote_day, .)

# Check that we have a 5:1 ratio of used:available points
table(coyote_day$ID,coyote_day$Used)

#check
# plot(coyote_hr[8,])
# plot(st_geometry(filter(coyote_all,ID == "M5",Used == 0)),col="red",add=T)
# plot(st_geometry(filter(coyote_all,ID == "M5",Used == 1)),add=T)
```
### Scale and append covariates
```{r}
#append and scale covariates
coyote_day <- coyote_day %>% 
  mutate(elev.s = raster::extract(envt[[1]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         slope.s = raster::extract(envt[[2]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         dev_dist.s = raster::extract(envt[[3]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         road_dist.s = raster::extract(envt[[4]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         crop_dist.s = raster::extract(envt[[5]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         grass_dist.s = raster::extract(envt[[6]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         forest_dist.s = raster::extract(envt[[7]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         shrub_dist.s = raster::extract(envt[[8]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         water_dist.s = raster::extract(envt[[9]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         lion.s = raster::extract(envt[[10]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         hunter.s = raster::extract(envt[[11]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE))
```

```{r}
landuse_mod_day <- glmer(Used ~ crop_dist.s + grass_dist.s + forest_dist.s + shrub_dist.s + dev_dist.s + (1|ID), 
                  data = coyote_day, family=binomial(link="logit"))
```


### Night top models

### Calculate Night Home Ranges (Kernel Utilization Distribution)
```{r}
#create object for calculating HRs
coyote_sp <- coyote %>%
   filter(daynight == 0) %>% #filter to day only
   dplyr::select(ID,x,y) %>% #select data 
   st_as_sf(., coords = c("x","y"), crs = "+init=epsg:4326") %>%  #make spatial object
   st_transform("+init=epsg:26910") %>% #transform back to UTMs
   as("Spatial") #transform back to sp object for KUDs

#create Kernel Utilization Distributions 
kud_all <- adehabitatHR::kernelUD(coyote_sp, h = 'href')
coyote_hr <- adehabitatHR::getverticeshr(kud_all, percent = 95 , unout = "km2")
#save(coyote_hr, file = "data_objects/coyote_hr.Rdata")

#plot
plot(coyote_hr, col = coyote_hr$ID)

#HR area (km2)
kernel.area(kud_all, percent = 95) %>% 
  pivot_longer(1:8,names_to = "ID", values_to = "Area (km^2)")
```


### Sample available points in Home Ranges
```{r}
coyote_night <- coyote %>% 
  filter(daynight == 0) %>% #filter to day only
  mutate(Used = 1) %>% #add column to indicate used points
   st_as_sf(., coords = c("x","y"), crs = "+init=epsg:4326") %>%  #make spatial object
   st_transform("+init=epsg:26910")  #transform back to UTMs

coyote_ids <- unique(coyote_night$ID) # Extract a list of IDs
availables <- list() #empty list to store available pts by ID

# Randomly sample available points from within the home range of each individual
for(i in 1:length(coyote_ids)){
    st_sample(st_as_sf(coyote_hr)[i,], 5*nrow(filter(coyote_night, ID == coyote_ids[i]))) %>%  #5:1 ratio
    st_sf(geometry = .) %>%
    mutate(ID = coyote_ids[i], 
           t = NA,
           states = NA,
           daynight = NA,
           sex = NA,
           Used = 0) -> availables[[i]]  
}

# Then combine individual lists into one data.frame
# Then merge with used coyote GPS points data frame
coyote_night <- availables %>% 
  do.call(rbind,.) %>% 
  rbind(coyote_night, .)

# Check that we have a 5:1 ratio of used:available points
table(coyote_night$ID,coyote_night$Used)
```

### Scale and append covariates
```{r}
#append and scale covariates
coyote_night <- coyote_night %>% 
  mutate(elev.s = raster::extract(envt[[1]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         slope.s = raster::extract(envt[[2]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         dev_dist.s = raster::extract(envt[[3]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         road_dist.s = raster::extract(envt[[4]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         crop_dist.s = raster::extract(envt[[5]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         grass_dist.s = raster::extract(envt[[6]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         forest_dist.s = raster::extract(envt[[7]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         shrub_dist.s = raster::extract(envt[[8]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         water_dist.s = raster::extract(envt[[9]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         lion.s = raster::extract(envt[[10]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE),
         hunter.s = raster::extract(envt[[11]], as(., "Spatial")) %>% scale(., center = TRUE, scale = TRUE))
```

```{r}
landuse_mod_night <- glmer(Used ~ crop_dist.s + grass_dist.s + forest_dist.s + shrub_dist.s + dev_dist.s + (1|ID), 
                  data = coyote_night, family=binomial(link="logit"))
```

### Plots & Tables 

```{r}
library(jtools)

#Best model
jtools::plot_summs(landuse_mod, landuse_mod_day, landuse_mod_night, scale = TRUE, 
           model.names = c("Full", "Day", "Night"),
           coefs = c("Crop dist."="crop_dist.s",
                     "Pasture dist."="grass_dist.s",
                     "Forest dist."="forest_dist.s",
                     "Shrub dist."="shrub_dist.s",
                     "Development dist."="dev_dist.s"), 
           colors = c("black","white","white")) 

#Best model - Day / Night
jtools::plot_summs(landuse_mod, landuse_mod_day, landuse_mod_night, scale = TRUE, 
           model.names = c("Full", "Day", "Night"),
           coefs = c("Crop dist."="crop_dist.s",
                     "Pasture dist."="grass_dist.s",
                     "Forest dist."="forest_dist.s",
                     "Shrub dist."="shrub_dist.s",
                     "Development dist."="dev_dist.s"), 
           colors = c("black","red","blue")) 

#Best model = Behavior
# jtools::plot_summs(full, rest_day, rest_night, scale = TRUE, 
#            model.names = c("Combined", "Rest (Day)", "Rest (Night)"),
#            coefs = c("Hunter risk"="hunter.s",
#                      "Lion risk"="lion.s",
#                      "Development dist."="dev_dist.s", 
#                      "Crop dist."="crop_dist.s",
#                      "Pasture dist."="grass_dist.s",
#                      "Forest dist."="forest_dist.s",
#                      "Shrub dist."="shrub_dist.s",
#                      "Road dist."="road_dist.s",
#                      "Slope"="slope.s"),  
#            colors = c("black","#E7B8BE","#E7B8EE"))
```


```{r}
sjPlot::tab_model(combined, rest_mod, forage_mod, travel_mod, 
          dv.labels = c("Combined","Resting","Foraging","Traveling"),
          pred.labels = c("Intercept", "Lion risk", "Hunter risk","Human presence", 
                          "Distance to Livestock", "Distance to Cropland", "Habitat"),
          show.re.var = FALSE, show.ngroups = FALSE, show.icc = FALSE,
          string.pred = "Covariates", string.ci = "CI", p.style = "stars")
```




