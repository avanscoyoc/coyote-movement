---
title: "iSSF"
author: "Amy Van Scoyoc"
date: "3/29/2022"
output: github_document
---

### Load Libraries
```{r}
library(here) #for setting working directory reproducibly
library(tidyverse) #for data manipulation
library(amt) #for animal movement tools (iSSF) 
library(sp) #for setting coordinate reference systems
library(lubridate) #for date/time adjustments
library(raster) #for environmental covariates
```


### Import environmental rasters
```{r}
raster_files <- list.files(here("data_covariates"), pattern = ".tif") 
envtrasters <- raster::stack(paste0(here("data_covariates"), raster_files))
names(envtrasters) <- c("dem", "max_ndvi", "slope", "tri")
```


### Import coyote dataset
```{r}
#import 2021-2022 data
data <- read_csv(here("data", "coyote_2021.12.01_2022.03.04.csv")) %>% 
  drop_na(`Longitude[deg]`) %>% #remove any empty locations
  dplyr::select(x = `Longitude[deg]`, y = `Latitude[deg]`, #select & rename columns
                timestamp = `Acq. Time [LMT]`, ID = `Collar ID`) %>% 
  nest(-ID) #group by collar ID

head(data)
```
```{r}
#make tracks for each animal id
d <- data %>% 
  mutate(trk = map(data, function(d){
    mk_track(d, x, y, timestamp, crs = CRS("+init=epsg:4326")) %>% #from WGS84
      transform_coords(CRS("+init=epsg:26910")) #transform to NAD83 UTM zone 10N
  }))

#check sampling rate is 1hr
d %>% 
  mutate(sr = lapply(trk, summarize_sampling_rate)) %>% 
  dplyr::select(ID, sr) %>% unnest
```
```{r}
#resample to 1hr
ssfdat <- d %>% 
  mutate(steps = map(trk, function(x){
    x %>% 
      track_resample(rate = hours(1), tolerance = minutes(5)) %>% #eliminate steps >1 hour
      filter_min_n_burst(min_n = 2)})) #eliminate bursts with <2 points

#compare
ssfdat %>%
  mutate(sr = lapply(steps, summarize_sampling_rate)) %>% 
  dplyr::select(ID, sr) %>% unnest
```

```{r}
ssf <- ssfdat %>%
    mutate(moddata = map(steps, function (x){
      x %>% 
        steps_by_burst() %>% 
        random_steps(n = 10) %>% #randomly sample 10 steps per real step
        time_of_day(where = "start") %>% #determine day or night from movement track data
        amt::extract_covariates(envtrasters,where="both")})) #extract covariates from our raster stack
```



